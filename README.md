# ğŸ¦€ ç¾å‘³èŸ¹å ¡ - é¤å…ç®¡ç†ç³»ç»Ÿåç«¯

ä¸€ä¸ªåŸºäº NestJS æ„å»ºçš„ç°ä»£åŒ–é¤å…/å¤–å–ç®¡ç†ç³»ç»Ÿåç«¯ APIï¼Œæ”¯æŒå°ç¨‹åºç”¨æˆ·ç«¯å’Œåå°ç®¡ç†ç«¯ã€‚

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

ç¾å‘³èŸ¹å ¡æ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„é¤å…ç®¡ç†ç³»ç»Ÿåç«¯ï¼Œæä¾›å®Œæ•´çš„ä¸šåŠ¡åŠŸèƒ½æ”¯æŒï¼ŒåŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€é¤å“ç®¡ç†ã€è®¢å•å¤„ç†ã€æ•°æ®ç»Ÿè®¡ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ”¯æŒå°ç¨‹åºç«¯å’Œåå°ç®¡ç†ç«¯ä¸¤ç§ç”¨æˆ·è§’è‰²ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- ğŸ” **åŒé‡èº«ä»½è®¤è¯ç³»ç»Ÿ**ï¼šæ”¯æŒå°ç¨‹åºç”¨æˆ·å’Œç®¡ç†å‘˜è§’è‰²ï¼Œä½¿ç”¨ JWT + Redis å®ç°å®‰å…¨è®¤è¯
- ğŸ“± **å°ç¨‹åºç”¨æˆ·åŠŸèƒ½**ï¼šæ³¨å†Œã€ç™»å½•ï¼ˆè´¦æˆ·/æ‰‹æœºå·ï¼‰ã€ä¸ªäººä¿¡æ¯ç®¡ç†ã€è®¢å•æŸ¥è¯¢ç­‰
- ğŸ‘¨â€ğŸ’¼ **åå°ç®¡ç†åŠŸèƒ½**ï¼šç®¡ç†å‘˜ç™»å½•ã€é¤å“ç®¡ç†ã€åˆ†ç±»ç®¡ç†ã€è®¢å•ç®¡ç†ã€è½®æ’­å›¾ç®¡ç†ç­‰
- ğŸ” **å®Œæ•´çš„é¤é¥®ä¸šåŠ¡**ï¼šé¤å“åˆ†ç±»ã€é¤å“ä¿¡æ¯ï¼ˆä»·æ ¼ã€åº“å­˜ã€é”€é‡ï¼‰ã€ä¸Šæ¶ä¸‹æ¶ç­‰
- ğŸ“¦ **è®¢å•ç³»ç»Ÿ**ï¼šè®¢å•åˆ›å»ºã€è®¢å•è¯¦æƒ…ã€è®¢å•çŠ¶æ€ç®¡ç†ï¼ˆå¾…æ”¯ä»˜ã€åˆ¶ä½œä¸­ã€å·²å®Œæˆã€å·²å–æ¶ˆï¼‰
- ğŸ¨ **å†…å®¹ç®¡ç†**ï¼šè½®æ’­å›¾ç®¡ç†ã€å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
- ğŸ“§ **çŸ­ä¿¡éªŒè¯**ï¼šé›†æˆé˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ï¼Œæ”¯æŒæ‰‹æœºå·éªŒè¯ç ç™»å½•
- âš¡ **é«˜æ€§èƒ½ç¼“å­˜**ï¼šä½¿ç”¨ Redis å®ç° Token ç¼“å­˜å’Œä¼šè¯ç®¡ç†
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤**ï¼šå¯†ç åŠ å¯†ï¼ˆbcryptï¼‰ã€è¯·æ±‚éªŒè¯ï¼ˆclass-validatorï¼‰ã€å…¨å±€å¼‚å¸¸å¤„ç†

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **NestJS 10.x** - æ¸è¿›å¼ Node.js æ¡†æ¶
- **TypeScript 5.x** - ç±»å‹å®‰å…¨çš„ JavaScript
- **TypeORM 0.3.x** - ORM æ¡†æ¶
- **MySQL** - å…³ç³»å‹æ•°æ®åº“
- - **Redis** - éå…³ç³»å‹æ•°æ®åº“

### ä¸»è¦ä¾èµ–
- **@nestjs/jwt** - JWT è®¤è¯
- **@nestjs/config** - é…ç½®ç®¡ç†
- **ioredis** - Redis å®¢æˆ·ç«¯
- **bcrypt** - å¯†ç åŠ å¯†
- **class-validator** - æ•°æ®éªŒè¯
- **multer** - æ–‡ä»¶ä¸Šä¼ 
- **@alicloud/dysmsapi20170525** - é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡
- **cors** - è·¨åŸŸæ”¯æŒ
- **express-session** - ä¼šè¯ç®¡ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
delicious_crab_burger/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app.module.ts          # åº”ç”¨æ ¹æ¨¡å—
â”‚   â”œâ”€â”€ main.ts                # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ app.controller.ts      # æ ¹æ§åˆ¶å™¨ï¼ˆéªŒè¯ç ç­‰ï¼‰
â”‚   â”œâ”€â”€ app.service.ts         # æ ¹æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ user/                  # å°ç¨‹åºç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ user.controller.ts
â”‚   â”‚   â”œâ”€â”€ user.service.ts
â”‚   â”‚   â”œâ”€â”€ user.module.ts
â”‚   â”‚   â”œâ”€â”€ entities/          # ç”¨æˆ·å®ä½“
â”‚   â”‚   â””â”€â”€ dto/               # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚
â”‚   â”œâ”€â”€ role/                  # åå°ç®¡ç†å‘˜æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ role.controller.ts
â”‚   â”‚   â”œâ”€â”€ role.service.ts
â”‚   â”‚   â”œâ”€â”€ role.module.ts
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ dto/
â”‚   â”‚
â”‚   â”œâ”€â”€ category/              # åˆ†ç±»æ¨¡å—
â”‚   â”œâ”€â”€ meals/                 # é¤å“æ¨¡å—
â”‚   â”œâ”€â”€ order/                 # è®¢å•æ¨¡å—
â”‚   â”œâ”€â”€ order_details/         # è®¢å•è¯¦æƒ…æ¨¡å—
â”‚   â”œâ”€â”€ banner/                # è½®æ’­å›¾æ¨¡å—
â”‚   â”œâ”€â”€ userConfig/            # ç”¨æˆ·é…ç½®æ¨¡å—
â”‚   â”œâ”€â”€ roleConfig/            # è§’è‰²é…ç½®æ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ guard/                 # å®ˆå«
â”‚   â”‚   â””â”€â”€ auth.guard.ts      # JWT è®¤è¯å®ˆå«
â”‚   â”‚
â”‚   â”œâ”€â”€ interception/          # æ‹¦æˆªå™¨
â”‚   â”‚   â”œâ”€â”€ responseIntercept.ts      # å“åº”æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ exceptionInterception.ts  # å¼‚å¸¸æ‹¦æˆªå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ index.ts           # æ—¥å¿—ä¸­é—´ä»¶
â”‚   â”‚
â”‚   â””â”€â”€ utils/                 # å·¥å…·ç±»
â”‚       â”œâ”€â”€ redis.service.ts   # Redis æœåŠ¡
â”‚       â”œâ”€â”€ sms.service.ts     # çŸ­ä¿¡æœåŠ¡
â”‚       â”œâ”€â”€ bcrypt.service.ts  # å¯†ç åŠ å¯†æœåŠ¡
â”‚       â”œâ”€â”€ axios.service.ts   # HTTP è¯·æ±‚æœåŠ¡
â”‚       â””â”€â”€ formatted.ts       # æ ¼å¼åŒ–å·¥å…·
â”‚
â”œâ”€â”€ upload/                    # ä¸Šä¼ æ–‡ä»¶ç›®å½•
â”œâ”€â”€ dist/                      # ç¼–è¯‘è¾“å‡ºç›®å½•
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ nest-cli.json
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.x
- pnpm >= 8.x (æˆ– npm/yarn)
- MySQL >= 5.7
- Redis >= 6.x

### å®‰è£…ä¾èµ–

```bash
# ä½¿ç”¨ pnpmï¼ˆæ¨èï¼‰
pnpm install

# æˆ–ä½¿ç”¨ npm
npm install

# æˆ–ä½¿ç”¨ yarn
yarn install
```

### ç¯å¢ƒé…ç½®

åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ `.env.development`ï¼ˆå¼€å‘ç¯å¢ƒï¼‰æˆ– `.env.production`ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

```env
# API é…ç½®
API_PREFIX=/api
NODE_ENV=development

# æ•°æ®åº“é…ç½®
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=delicious_crab_burger

# JWT é…ç½®
JWT_SECRET=your_jwt_secret_key

# Redis é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# ä¼šè¯é…ç½®
SESSION_SECRET=your_session_secret
SESSION_NAME=session_id

# é˜¿é‡Œäº‘çŸ­ä¿¡é…ç½®ï¼ˆå¯é€‰ï¼‰
SMS_ACCESS_KEY_ID=your_access_key_id
SMS_ACCESS_KEY_SECRET=your_access_key_secret
SMS_SIGN_NAME=your_sign_name
SMS_TEMPLATE_CODE=your_template_code
```

### è¿è¡Œé¡¹ç›®

```bash
# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
pnpm run start:dev

# ç”Ÿäº§æ¨¡å¼
pnpm run start:prod

# è°ƒè¯•æ¨¡å¼
pnpm run start:debug
```

é¡¹ç›®å°†åœ¨ `http://localhost:8311` å¯åŠ¨ã€‚

### æ„å»ºé¡¹ç›®

```bash
pnpm run build
```

## ğŸ“š API æ–‡æ¡£

### åŸºç¡€è·¯å¾„

æ‰€æœ‰ API è¯·æ±‚å‰ç¼€ï¼š`/api/v1`

### å…¬å…±æ¥å£

#### è·å–å›¾å½¢éªŒè¯ç 
```
GET /api/v1/imageVerificationCode
```

#### è·å–çŸ­ä¿¡éªŒè¯ç 
```
GET /api/v1/verificationCode?phone=æ‰‹æœºå·
```

### å°ç¨‹åºç”¨æˆ·æ¥å£

#### ç”¨æˆ·æ³¨å†Œ
```
POST /api/v1/user/miniProgram/register
Body: { phone, password, verificationCode }
```

#### è´¦æˆ·ç™»å½•
```
POST /api/v1/user/miniProgram/login
Body: { phone, password }
```

#### æ‰‹æœºå·å…å¯†ç™»å½•
```
POST /api/v1/user/miniProgram/loginByPhone
Body: { phone, verificationCode }
```

#### æ›´æ–°ç”¨æˆ·ä¿¡æ¯
```
PATCH /api/v1/user/miniProgram/updateInfo
Headers: Authorization: Bearer {token}
Body: { nickname, avatar, ... }
```

#### ä¿®æ”¹å¯†ç 
```
PATCH /api/v1/user/miniProgram/updatePassword
Headers: Authorization: Bearer {token}
Body: { oldPassword, newPassword }
```

### ç®¡ç†å‘˜æ¥å£

#### ç®¡ç†å‘˜æ³¨å†Œ
```
POST /api/v1/role/register
Body: { phone, password }
```

#### ç®¡ç†å‘˜ç™»å½•
```
POST /api/v1/role/login
Body: { phone, password }
```

### åˆ†ç±»ç®¡ç†

#### åˆ›å»ºåˆ†ç±»
```
POST /api/v1/category
Headers: Authorization: Bearer {token}
Body: { name, status }
```

#### è·å–åˆ†ç±»åˆ—è¡¨
```
GET /api/v1/category
Headers: Authorization: Bearer {token}
```

#### æ›´æ–°åˆ†ç±»
```
PATCH /api/v1/category/:id
Headers: Authorization: Bearer {token}
```

#### åˆ é™¤åˆ†ç±»
```
DELETE /api/v1/category/:id
Headers: Authorization: Bearer {token}
```

### é¤å“ç®¡ç†

#### åˆ›å»ºé¤å“
```
POST /api/v1/meals
Headers: Authorization: Bearer {token}
Body: { name, price, originalPrice, desc, category_id, ... }
```

#### è·å–é¤å“åˆ—è¡¨
```
GET /api/v1/meals
Headers: Authorization: Bearer {token}
```

#### æ›´æ–°é¤å“
```
PATCH /api/v1/meals/:id
Headers: Authorization: Bearer {token}
```

#### åˆ é™¤é¤å“
```
DELETE /api/v1/meals/:id
Headers: Authorization: Bearer {token}
```

### è®¢å•ç®¡ç†

#### åˆ›å»ºè®¢å•
```
POST /api/v1/order
Headers: Authorization: Bearer {token}
Body: { meals: [{ meal_id, quantity }], total_price }
```

#### è·å–è®¢å•åˆ—è¡¨
```
GET /api/v1/order
Headers: Authorization: Bearer {token}
```

#### æ›´æ–°è®¢å•çŠ¶æ€
```
PATCH /api/v1/order/:id
Headers: Authorization: Bearer {token}
Body: { status }
```

### è½®æ’­å›¾ç®¡ç†

#### åˆ›å»ºè½®æ’­å›¾
```
POST /api/v1/banner
Headers: Authorization: Bearer {token}
Body: { name, url, sort, status }
```

#### è·å–è½®æ’­å›¾åˆ—è¡¨
```
GET /api/v1/banner
Headers: Authorization: Bearer {token}
```

## ğŸ” è®¤è¯è¯´æ˜

ç³»ç»Ÿä½¿ç”¨ JWT Token è¿›è¡Œèº«ä»½è®¤è¯ï¼ŒToken å­˜å‚¨åœ¨ Redis ä¸­ç”¨äºä¼šè¯ç®¡ç†ã€‚

### è¯·æ±‚å¤´æ ¼å¼

```
Authorization: Bearer {token}
```

### Token ç»“æ„

- **å°ç¨‹åºç”¨æˆ·**ï¼š`source: 'miniProgram'`
- **åå°ç®¡ç†å‘˜**ï¼š`source: 'BackgroundManagement'`

### æ— éœ€è®¤è¯çš„æ¥å£

ä»¥ä¸‹æ¥å£ä¸éœ€è¦è®¤è¯å³å¯è®¿é—®ï¼š
- `/api/v1/verificationCode`
- `/api/v1/imageVerificationCode`
- `/api/v1/user/miniProgram/register`
- `/api/v1/user/miniProgram/login`
- `/api/v1/user/miniProgram/loginByPhone`
- `/api/v1/role/login`
- `/api/v1/role/register`

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ä¸»è¦å®ä½“

- **MiniProgramUser** - å°ç¨‹åºç”¨æˆ·
- **Role** - åå°ç®¡ç†å‘˜
- **Category** - é¤å“åˆ†ç±»
- **Meals** - é¤å“ä¿¡æ¯
- **Order** - è®¢å•
- **OrderDetail** - è®¢å•è¯¦æƒ…
- **Banner** - è½®æ’­å›¾
- **UserConfig** - ç”¨æˆ·é…ç½®
- **RoleConfig** - è§’è‰²é…ç½®

### å…³ç³»è¯´æ˜

- ç”¨æˆ·ï¼ˆMiniProgramUserï¼‰ â†” è®¢å•ï¼ˆOrderï¼‰ï¼šä¸€å¯¹å¤š
- è®¢å•ï¼ˆOrderï¼‰ â†” è®¢å•è¯¦æƒ…ï¼ˆOrderDetailï¼‰ï¼šä¸€å¯¹å¤š
- è®¢å•è¯¦æƒ…ï¼ˆOrderDetailï¼‰ â†” é¤å“ï¼ˆMealsï¼‰ï¼šå¤šå¯¹å¤š
- åˆ†ç±»ï¼ˆCategoryï¼‰ â†” é¤å“ï¼ˆMealsï¼‰ï¼šä¸€å¯¹å¤š
- è§’è‰²ï¼ˆRoleï¼‰ â†” åˆ†ç±»ï¼ˆCategoryï¼‰ï¼šä¸€å¯¹å¤š
- è§’è‰²ï¼ˆRoleï¼‰ â†” é¤å“ï¼ˆMealsï¼‰ï¼šä¸€å¯¹å¤š

## ğŸ“ æ–‡ä»¶ä¸Šä¼ 

ä¸Šä¼ çš„æ–‡ä»¶å­˜å‚¨åœ¨ `upload/` ç›®å½•ä¸‹ï¼Œé€šè¿‡ä»¥ä¸‹è·¯å¾„è®¿é—®ï¼š

```
GET /image/{filename}
```

ç¤ºä¾‹ï¼š`/image/banner1.jpg`


## ğŸ“ ä»£ç è§„èŒƒ

é¡¹ç›®ä½¿ç”¨ ESLint + Prettier è¿›è¡Œä»£ç æ ¼å¼åŒ–ï¼š

```bash
# ä»£ç æ£€æŸ¥
pnpm run lint

# ä»£ç æ ¼å¼åŒ–
pnpm run format
```

## ğŸ”§ å¼€å‘å·¥å…·

- **TypeScript** - ç±»å‹æ£€æŸ¥
- **ESLint** - ä»£ç è´¨é‡æ£€æŸ¥
- **Prettier** - ä»£ç æ ¼å¼åŒ–
- **Jest** - å•å…ƒæµ‹è¯•æ¡†æ¶

## ğŸ“¦ éƒ¨ç½²

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆ`.env.production`ï¼‰
2. æ„å»ºé¡¹ç›®ï¼š`pnpm run build`
3. è¿è¡Œï¼š`pnpm run start:prod`


```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN pnpm install --production
COPY dist ./dist
CMD ["node", "dist/main"]
```


âš ï¸ æœ¬é¡¹ç›®ä»…ä¾›ä¸ªäººå­¦ä¹ ä¸ç ”ç©¶ä½¿ç”¨ã€‚ è¯·å‹¿å°†æœ¬é¡¹ç›®ç”¨äºä»»ä½•å•†ä¸šç”¨é€”æˆ–è¿æ³•ç”¨é€”ã€‚ è‹¥äº§ç”Ÿæ³•å¾‹çº çº·ï¼Œä½œè€…ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚
